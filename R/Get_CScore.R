#' calculates a coopretivity score
#'
#' Generates coopretivity boxplots immune checkpoints
#' @param fdata a formatted dataframe
#' @keywords synergy
#' @return a dataframe with gene names and synergy scores
#' @export
#' @examples im_syng(fdata=myformatteddata)
#' Get_CScore()

Get_CScore=function(fdata){
  if(nrow(fdata)==0){
    sscoreij <- data.frame(Gene=colnames(fdata)[3],
      ICP=colnames(fdata)[4],
      Immune_Feature=colnames(fdata)[2],
      CScore= NA, pvalueA_AB=NA,pvalueB_AB=NA)
  }else{
    fdata$state <- as.integer((fdata[,3]*2+fdata[,4])/3)
    dft1 <- fdata[fdata$state==1,2]
    dft2 <- fdata[fdata$state==2,2]
    dft3 <- fdata[fdata$state==3,2]
    dft4 <- fdata[fdata$state==4,2]

    n1 <- length(dft1)
    n2 <- length(dft2)
    n3 <- length(dft3)
    n4 <- length(dft4)

    if(n1<1 || n2<1 || n3<1 || n4<1){
      CS <- NA
      Cp1 <- NA
      Cp2 <- NA
    }else{
      m1 <- median(dft1,na.rm=T)
      m2 <- median(dft2,na.rm=T)
      m3 <- median(dft3,na.rm=T)
      m4 <- median(dft4,na.rm=T)

      ma <- (m2-m1)
      mb <- (m3-m1)
      mc <- (m4-m1)
      CS_sign <- floor(abs(sign(ma) + sign(mb) + sign(mc)) / 3)
      CS <- CS_sign * (abs(mc) - max(abs(ma) , abs(mb)))
      Cp1 <- wilcox.test(dft3 , dft4 , paired = F , exact = F)$p.value
      Cp2 <- wilcox.test(dft2 , dft4 , paired = F , exact = F)$p.value
    }
    sscoreij <- data.frame(Gene=colnames(fdata)[3],
      ICP=colnames(fdata)[4],
      Immune_Feature=colnames(fdata)[2],
      CScore=CS,pvalueA_AB=Cp1,pvalueB_AB=Cp2)
  }
  return(sscoreij)
}
